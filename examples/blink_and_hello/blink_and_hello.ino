#include <mrubyc.h>

#define MEMORY_SIZE (1024*30)
static uint8_t memory_pool[MEMORY_SIZE];

/* rubyプログラム
while true
    ledWrite(1)
    sleep(1)
    ledWrite(0)
    sleep(1)
    puts "HELLO WORLD"
end
*/

uint8_t ruby_pg[] = {
0x52,0x49,0x54,0x45,0x30,0x30,0x30,0x36,0xf8,0x85,0x00,0x00,0x00,0x9f,0x4d,0x41,
0x54,0x5a,0x30,0x30,0x30,0x30,0x49,0x52,0x45,0x50,0x00,0x00,0x00,0x81,0x30,0x30,
0x30,0x32,0x00,0x00,0x01,0x1e,0x00,0x01,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x37,
0x21,0x00,0x2c,0x10,0x01,0x07,0x02,0x2e,0x01,0x00,0x01,0x10,0x01,0x07,0x02,0x2e,
0x01,0x01,0x01,0x10,0x01,0x06,0x02,0x2e,0x01,0x00,0x01,0x10,0x01,0x07,0x02,0x2e,
0x01,0x01,0x01,0x10,0x01,0x4f,0x02,0x00,0x2e,0x01,0x02,0x01,0x11,0x01,0x22,0x01,
0x00,0x03,0x0f,0x01,0x37,0x01,0x67,0x00,0x00,0x00,0x01,0x00,0x00,0x0b,0x48,0x45,
0x4c,0x4c,0x4f,0x20,0x57,0x4f,0x52,0x4c,0x44,0x00,0x00,0x00,0x03,0x00,0x08,0x6c,
0x65,0x64,0x57,0x72,0x69,0x74,0x65,0x00,0x00,0x05,0x73,0x6c,0x65,0x65,0x70,0x00,
0x00,0x04,0x70,0x75,0x74,0x73,0x00,0x45,0x4e,0x44,0x00,0x00,0x00,0x00,0x08,
};

// led出力関数
static void c_led_write(mrb_vm *vm, mrb_value *v, int argc)
{
  digitalWrite(LED_BUILTIN,GET_INT_ARG(1));
}

int hal_write(int fd, const void *buf, int nbytes) {
    Serial.print((char*)buf);
    return (nbytes);
}

int hal_flush(int fd) {
    return 0;
}


void setup() {
  Serial.begin(19200);
  pinMode(LED_BUILTIN, OUTPUT);
}

void loop() {
  mrbc_init(memory_pool, MEMORY_SIZE);
  mrbc_define_method(0, mrbc_class_object, "ledWrite", c_led_write);
  mrbc_create_task( ruby_pg, 0 );
  mrbc_run();
}
